<!DOCTYPE html>

<html lang = "en">
   <head>
  <!--    <script src = "js/d3.js"></script>  -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src = "https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
<script src = "https://dc-js.github.io/dc.js/js/dc.js"></script>
<!-- <script src = "http://localhost/CustomBubbles.js"></script> -->
<script src = "CustomBubbles.js"></script>


<link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/dc.css"/>

<link href="https://assets.website-files.com/5ed4a1b297a20a05d4926631/css/k4i-nemisa.webflow.7ccc35bf6.css"
        rel="stylesheet" type="text/css" />

   </head>

<style>
.blue {
    color: blue;
}
.dc-chart g.row text {
    fill: black;
}
.review {
    fill: red;
}

.chart-filter__name {
    max-width: unset;
}

#dc-learn-bubbles .circle:hover{
   stroke: purple !important;
}

</style>
   
<body>

<div class='container' style='font: 12px sans-serif;'>

    <div class="chart-filters__label">Survey filters:</div>

        <div class="chart-filter-template" style="visibility: hidden">
            <div class="chart-filter__name truncate">High speed internet connection</div>
            <div class="chart-filter__remove">
                <div class="fa-icon"></div>
            </div>
        </div>

    <div class="chart-filters__wrap">
        <div style="display:none;opacity:0" class="chart-filters__bg"></div>
        <div id="w-node-42ca836218b3-86e98330" class="chart-filters__inner">
            <div class="chart-filter chart-filter--default">
                <div class="chart-filter__name">No filters applied</div>
            </div>
            <div class="chart-filter">
                <div class="chart-filter__name truncate">High speed internet connection</div>
                <div class="chart-filter__remove">
                    <div class="fa-icon"></div>
                </div>
            </div>
            <div class="chart-filter">
                <div class="chart-filter__name truncate">High speed internet connection</div>
                <div class="chart-filter__remove">
                    <div class="fa-icon"></div>
                </div>
            </div>
        </div>
        <div id="w-node-0759ecf6ee71-86e98330" class="chart-filters__filtered-value">Filtered: <span
                class="filtered-value">320/376</span></div>
    </div>





<div id="filteredInfo" class="filtered-value"></div>
    

<!-- <div id = 'vis'></div> -->

    <h4>Target: union (select multiple different groups)</h4>

        <div>
            <div id="dc-activities-heatmap"></div>
        </div>

        <div>
            <div id = "dc-gender-chart"></div>
        </div>

        <h4>Fears (not for filtering, just aggregation)
        <div>
            
        </div>
        <div class="summary-block">
            <div class="block-inner">
                <h4 class="overview-chart__title">Perceived risk:</h4>
                <div class="overview-chart__largest">
                    <div class="overview-chart__largest_icon fa-icon"></div>
                    <div class="overview-chart__largest_name">Data security</div>
                </div>
                <div id="dc-risk-bubbles" class="overview-chart__chart"></div>
                
            </div>
        </div>

        <div>
            <div id="dc-attitude-tech-heatmap"></div>
        </div>

        <h4>Target: intersection (choose chart)</h4>
        <div>
            <div id = "dc-learn-hor"></div>
        </div>

        <div>
            <div id="dc-learn-bubbles"></div>
        </div>

        <div>
            <div id = "dc-birth-chart"></div>
        </div>



      
      <table id="dc-test-table" class="table table-striped"></table>

</div>  




      <script>


// dbg counter
const aggDict = {'some': 0}
function dbg_by_name(name, smthPrintable, limit){
    aggDict[name] = (aggDict[name] || 0) + 1;
    var limitPerKey = limit? limit : 10
    if (aggDict[name] < limitPerKey){
        // aggDict += 1
        console.log("PRINT TAG " + name + " :     ", smthPrintable)
    }
}

const EMAILING = 'How often do you use digital technologies to perform the following ACTIVITIES in your workplace? [Emailing]'
const SELFTAUGHT = 'How did you learn to use the digital technologies currently used in your organisation? Tick all that apply (More than one option can be selected). [Self-taught]'
const SHORTCOURSES = 'How did you learn to use the digital technologies currently used in your organisation? Tick all that apply (More than one option can be selected). [Short-courses]'

const BUB1_WIDTH = 312
const BUB1_HEIGHT = 256

function replaceLong(s){

    console.log("REPLL", s)
    if (!s) return s;   //undefined

    s = s.replace('How often do you use digital technologies to perform the following ACTIVITIES in your workplace?', 'Activities')

    return s
}


var fTableSize = 15

// location to centre the bubbles
const centre = { x: BUB1_WIDTH/2, y: BUB1_HEIGHT/2 };
// strength to apply to the position forces
const forceStrength = 0.05;

// charge is dependent on size of the bubble, so bigger towards the middle
function charge(d) {
    return Math.pow(d.radius, 2.0) * 0.5
}

const cdcd = new Date();
const year = cdcd.getFullYear();
console.log(year);


function extractBraces(s){
  return s.split('[').pop().split(']')[0];
}


function parseYN(s){
  // TODO different rows may use different data schema
 if (s == "Yes") return "Yes";
 else return "No";
}


// https://dc-js.github.io/dc.js/examples/heat.html  [1st big table]
// or https://dc-js.github.io/dc.js/examples/heatmap-filtering.html

var fn = "nnn_survey.json"
//var fn = "a.json"


var genderPie = dc.pieChart("#dc-gender-chart");
var learnTagsChart = dc.rowChart("#dc-learn-hor");
var activHeatmapChart = new dc.HeatMap("#dc-activities-heatmap")
var learnBubbleChart = new CustomBubbles("#dc-learn-bubbles")
var riskAggBubbleChart = new CustomBubbles("#dc-risk-bubbles")
var birthChart = dc.barChart("#dc-birth-chart");

// TODO too complicated logic of tags by birthChart (like 1990-1995)
const CHARTS = [genderPie, learnTagsChart, activHeatmapChart, riskAggBubbleChart, learnBubbleChart];


d3.json(fn, function(data) {
    // console.log(data);


var facts = crossfilter(data);
var all = facts.groupAll();
const C_ALL = all.reduceCount().value();


//var rowAI = "In your opinion what are the other digital technologies you will require to perform your job in the future? If you are unsure, leave blank. [Artificial Intelligence (AI)]";
//return parseYN(data[rowAI]); 

//====================================
// 0 Gender
// Pie-chart 

var genderDimension = facts.dimension(function(data) { 
   return data['Gender']; 
});

// var ttttttt = genderDimension.top(Infinity);
// console.log('GDT', ttttttt)       // array 367

var genderGroup = genderDimension.group().reduceCount();

// var ggggg = genderGroup.top(Infinity);
// console.log('GGP', ggggg)           // array 3:  { key: "Female", value: 249 }, {}, {}

genderPie
   .width(200)
   .height(200)
   .innerRadius(50)
   .drawPaths(true)
   .dimension(genderDimension)
   .group(genderGroup)

   .on('postRedraw', function(chart){
       postProc();
   })



//   .on('renderlet', function(chart) {
//      chart.selectAll('rect').on('click', function(d) {
//         console.log('click!', d);
//      });
//   });   


// multi-tags   https://jsfiddle.net/PBrockmann/x3jdxkqb/
//=======================================================
// 1 How often do you use digital tech 
// Squared-Heatmap

if (1){

    var ACTIV_FREQ = ["Never", "Rarely", "Half the time", "Often", "Always"];
    function activ2num(s) {
        //return ACTIV_FREQ.indexOf(s);
        return s;
    }

    function grabActivKeysArray(row) {

        const ks = Object.keys(row).filter(function (el) {
            return el.includes("technologies to perform the following ACTIVITIES");
        })
        //return ks.map( key => ({ [key]: activ2num(row[key]) }));   // [{Email:3}, {Phone:1}, {}...]
        return ks.map(key => ([key, activ2num(row[key])]));      // [[Email,3], [Phone,1], []...]
    }


    function activReduceAdd(p, v) {
        grabActivKeysArray(v).forEach(function (ob, idx) {

            //console.log(ob)    // {Email: 3}
            //Object.keys(ob).forEach(k => p[k] = (p[k] || 0) + ob[k])
            p[ob] = (p[ob] || 0) + 1;
        });
        return p;
    }

    function activReduceRemove(p, v) {
        grabActivKeysArray(v).forEach(function (ob, idx) {
            //Object.keys(ob).forEach(k => p[k] = (p[k] || 0) - ob[k])
            p[ob] = (p[ob] || 0) - 1;
        });
        return p;
    }

    function activReduceInitial() {
        return [];   // pairs {Email, 0}:5users, {Email, 1}:12users, ....
    }

    var ttt = facts.dimension(function (d) { return grabActivKeysArray(d) });
    var activDim = facts.dimension(function (d) { return grabActivKeysArray(d) });
    var activGroupall = ttt.groupAll();
    console.log(activGroupall);
    var activGroup = activGroupall.reduce(activReduceAdd, activReduceRemove, activReduceInitial).value();



    activGroup.all = function () {
        var newObject = [];
        for (var key in this) {      // "bla bla [bla],Often"   Looks like it was serialized to string
            var commaInd = key.lastIndexOf(',');
            var keyAct = key.slice(0, commaInd);
            var keyScore = key.slice(commaInd + 1);
            
            if (this[key] && key != "all") {
                newObject.push({
                    key: [keyAct, keyScore],
                    value: this[key]
                }); 
                // dbg_by_name('ga', newObject)    // "How often r workplace? [Designing],Always": 106
                // dbg_by_name('gb', this)         // array[5]
            }
        }
        return newObject;
    }

    // https://overcoder.net/q/112545/%D0%B5%D1%81%D1%82%D1%8C-%D0%BB%D0%B8-%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1-%D1%83%D0%BA%D0%B0%D0%B7%D0%B0%D1%82%D1%8C-crossfilter-%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%B0%D1%82%D1%8B%D0%B2%D0%B0%D1%82%D1%8C-%D1%8D%D0%BB%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2%D0%B0-%D0%BA%D0%B0%D0%BA-%D0%BE%D1%82%D0%B4%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5
    // https://bl.ocks.org/emiguevara/4bd152a8828f6b31270702d97dc0133d

    activHeatmapChart
        .width(600)
        .height(200)
        .dimension(activDim)
        //.dimension(ttt)
        .group(activGroup)
        .keyAccessor(function (d) { return extractBraces(d.key[0]); })
        .valueAccessor(function (d) { return d.key[1]; })
        .colorAccessor(function (d) { return +d.value; })
        .title(function (d) {
            return "Activity:   " + extractBraces(d.key[0]) + "\n" +
                "Frequency:  " + d.key[1] + "\n" +
                "People: " + (d.value);
        })
        .colors(["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"])
        .calculateColorDomain()
        .ordering(function (d) { return ACTIV_FREQ.indexOf(d.key[1]) })    // TODO ??????
        // TODO https://dc-js.github.io/dc.js/examples/focus-ordinal-bar.html
        .filterHandler (function (dimension, filters) {
                // filters = array of [Email, Often]
                dimension.filter(null);
                dbg_by_name('actAllFilters', filters)
                activeChartFiltersDict = Object.fromEntries(filters);
                dbg_by_name('actKVFilters', activeChartFiltersDict)
                
                dimension.filterFunction(function (d) {
                    // d = array11 of [Email, Often]
                    dbg_by_name('actRowCategories', d, 40)

                    for (var i=0; i < d.length; i++) {
                        var rowCatKey = d[i][0];
                        var rowCatVal = d[i][1];
                        // IMPLEMENT ANY
                        if (activeChartFiltersDict[rowCatKey] == rowCatVal) return true;
                    }
                    return false;
                }); 
                return filters;
            })

    activHeatmapChart.xBorderRadius(0);
    activHeatmapChart.yBorderRadius(0);
}

//------------------------------------------------
//2 Preceived Risks 
// aggregated ctg (most dangerous tech)

var RISK_FREQ = ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"];
const agreeDisagreeValueMap = {
                'Strongly Disagree': 0,
                'Disagree': 0,
                'Neutral': 0,
                'Agree': 1,
                'Strongly Agree': 1,
            }
    

    function grabRiskKeysArray(row) {

        const ks = Object.keys(row).filter(function (el) {
            return el.includes("Perceived risk associated with digital technology usage in the workplace");
        })
        return ks.map(key => ([key, RISK_FREQ.indexOf(row[key])]));      // [[Email,3], [Phone,1], []...]
    }

    function riskReduceAdd(p, v) {
        grabRiskKeysArray(v).forEach(function (ob, idx) {

            //console.log(ob)    // {Email: 3}
            //Object.keys(ob).forEach(k => p[k] = (p[k] || 0) + ob[k])
            var k = ob[0], v = ob[1]
            p[k] = (p[k] || 0) + v;
            dbg_by_name('aqqq', p)   
        });
        return p;
    }

    function riskReduceRemove(p, v) {
        grabRiskKeysArray(v).forEach(function (ob, idx) {
            //Object.keys(ob).forEach(k => p[k] = (p[k] || 0) - ob[k])
            var k = ob[0], v = ob[1]
            p[k] = (p[k] || 0) - v;
        });
        return p;
    }

    function riskReduceInitial() {
        return [];   // pairs {Email, 0}:5users, {Email, 1}:12users, ....
    }

    var r1 = facts.dimension(function (d) { return grabRiskKeysArray(d) });
    var riskDim = facts.dimension(function (d) { return grabRiskKeysArray(d) });
    var r2 = r1.groupAll();
    console.log(r2);
    var r4 = r2.reduce(riskReduceAdd, riskReduceRemove, riskReduceInitial).value();


    // console.log('pip', r4);
    
    r4.all = function () {
        var newObject = [];
        for (var key in this) {      
            
            if (this[key] && key != "all") {
                newObject.push({
                    key: key,
                    value: this[key]
                }); 
                // dbg_by_name('aga', newObject)    // "How often r workplace? [Designing],Always": 106
                // dbg_by_name('agb', this)         // array[5]
            }
        }
        return newObject;
    }


    riskAggBubbleChart 
        .width(BUB1_WIDTH)
        .height(BUB1_HEIGHT)
        // BUBBLE_NODE_CLASS (g)= 'whatever'
        .dimension(riskDim)
        .group(r4)
        .clipPadding(0)
        .maxBubbleRelativeSize(0.5)
        .r(d3.scaleLinear().domain([1,6]))
        .y(d3.scaleLinear().domain([0,BUB1_HEIGHT]))
        .x(d3.scaleLinear().domain([0,BUB1_WIDTH]))
        .keyAccessor(function(d){ console.log(d); return d.key[0]; })   // d.key[0];
        .valueAccessor(function(d){ return d.key[1]; })                 // d.key[1];
        .radiusValueAccessor(function(d){ return d.value; })            // d.value;
        .colorAccessor(function(d){ return d.value; })
        //.colors(d3.scale.category10())
        .label(d => extractBraces(d.key) + ' SCORE ' + d.value)
        .title(function (d) {
            return extractBraces(d.key) + ' ' + d.value;
        })
        .filter = function() {}
        .onClick = function(){}
        /*
        // NO filtering available (because it has no sence)
        .filterHandler (function (dimension, filters) {
            
            console.log("NOT STRICT FILTER");

            dimension.filter(null);
            dimension.filterFunction(function (d) {
                for (var i=0; i < filters.length; i++) {
                    if (d.indexOf(filters[i]) <0) return false;
                }
                return true;
            });
            return filters;
        })
        */
       // something at the bottom


//------------------------------------------------
//3 Year of Birth

// for YB
var ybDimension = facts.dimension(function (d) {
    return d["Year of Birth"];
});
var ybGroupSum = ybDimension.group()
    .reduceSum(function (d) { return d["Year of Birth"]; });	// sums 
var ybGroupCount = ybDimension.group()
    .reduceCount(function (d) { return d["Year of Birth"]; }) // counts 

// var y = d3.scaleLinear().rangeRound([0, height]).domain([0, 100]);


// YB Bar Graph Counted
birthChart.width(480)
    .height(150)
    .margins({ top: 10, right: 10, bottom: 20, left: 40 })
    .dimension(ybDimension)
    .group(ybGroupCount)
    .transitionDuration(500)
    .centerBar(true)
    .gap(65)  // 65 = norm
    //    .filter([3, 5])
    .x(d3.scaleLinear().domain([1920, 2020]))
    .elasticY(true)
    .xAxis().tickFormat();


//--------------------------------------------------------------------------
// How you learnt your skills
// 4.1 rows

function grabLearnKeysArray(row){
    const result = Object.keys(row).filter(function(el) {
        return row[el] == "Yes" && el.includes("How did you learn");
    })
    return result;
}

function learnReduceAdd(p, v) {
    grabLearnKeysArray(v).forEach (function(val, idx) {
        p[val] = (p[val] || 0) + 1; //increment counts
    });
    return p;
}

function learnReduceRemove(p, v) {
    grabLearnKeysArray(v).forEach (function(val, idx) {
        p[val] = (p[val] || 0) - 1; //decrement counts
    });
    return p;
}

function learnReduceInitial() {
    return [];
}

if (1){
    console.log('learn chart init')

    var learnTags = facts.dimension(function (d) { return grabLearnKeysArray(d) });
    var learnTags2 = facts.dimension(function (d) { return grabLearnKeysArray(d) });
    var learnGroupall = learnTags.groupAll();
    var learnTagsGroup = learnGroupall.reduce(learnReduceAdd, learnReduceRemove, learnReduceInitial).value();
    learnTagsGroup.all = function() {
        var newObject = [];
        for (var key in this) {
            if (this[key] && key != "all") {
                newObject.push({
                    key: key,
                    value: this[key]
                });
            }
        }
        return newObject;
    }


learnTagsChart
    .width(400)
    .height(300)
    .renderLabel(true)
    .labelOffsetY(10)
    .gap(2)
    .group(learnTagsGroup)
    .dimension(learnTags2)
    .elasticX(true)
    .label(function (d) { return extractBraces(d.key) + ' ' + d.value })   // extract cat between braces

    .transitionDuration(1500)   //ms

// !!! without FH - it will select only those with YES at 1!!! category
// it runs ONCE by ONLY THIS chart add/remove filter (click smth)
        .filterHandler (function (dimension, filters) {
            // filters = all filters to be applied by THIS chart  (like '..[SMTH]')

            dimension.filter(null);
            dimension.filterFunction(function (d) {
                // d = Array of filters which are applicable to current row (YES): ['Email', 'Training', ..]
                // for each row (in dimension probably)
                // todo check group-by-group maybe
                // executed always 367 times

                for (var i=0; i < filters.length; i++) {
                    if (d.indexOf(filters[i]) <0) return false;
                }
                return true;
            });
            return filters;
        })
        .xAxis().ticks(5);
    }

//--------------------------------------------------------------------------
// How you learnt your skills
// 4.2 bubble (same dimensions are used between them)

learnBubbleChart 
    .width(BUB1_WIDTH)
    .height(BUB1_HEIGHT)
    // BUBBLE_NODE_CLASS (g)= 'whatever'
    .dimension(learnTags2)
    .group(learnTagsGroup)
    .clipPadding(60)
    .maxBubbleRelativeSize(0.5)
    .r(d3.scaleLinear().domain([1,6]))
    .y(d3.scaleLinear().domain([0,BUB1_HEIGHT]))
    .x(d3.scaleLinear().domain([0,BUB1_WIDTH]))
    .keyAccessor(function(d){ console.log(d); return d.key[0]; })   // d.key[0];
    .valueAccessor(function(d){ return d.key[1]; })                 // d.key[1];
    .radiusValueAccessor(function(d){ return d.value; })            // d.value;
    .colorAccessor(function(d){ return d.value; })
    //.colors(d3.scale.category10())
    .label(d => extractBraces(d.key) + ' ' + d.value)
    .title(function (d) {
        return extractBraces(d.key) + ' ' + d.value;
    })
    .filterHandler (function (dimension, filters) {
        
        console.log("NOT STRICT FILTER");

        dimension.filter(null);
        dimension.filterFunction(function (d) {
            for (var i=0; i < filters.length; i++) {
                if (d.indexOf(filters[i]) <0) return false;
            }
            return true;
        });
        return filters;
    })

//=============================================
// Print filtered notes -> DBG
// 5

// var dimension = index.dimension(dc.pluck('key'));
// to debug:  group.top(Infinity);     or group.all()
// https://dc-js.github.io/dc.js/docs/stock.html
// data table 
var fTable = new dc.DataTable("#dc-test-table");



// if no id here: facts (looks like only used for sorting)
var zeroDimension = facts.dimension(function (d) { return 0; });
console.log('ZDT', zeroDimension.top(Infinity))

var zeroGroup = zeroDimension.group(function(d){ return "ITEMS top " + fTableSize })
console.log('ZGT', zeroGroup.top(Infinity))


fTable
    .dimension(zeroDimension)
    .width(500)
    .height(500)
    // .columns(['author', 'pid'])  //Job Title, Gender
    .columns(['Job Title', 'Gender', EMAILING, SELFTAUGHT, SHORTCOURSES])
    .size(fTableSize)   // Infinity


//----------------------------------------------------------------------------------------------
// Render the Charts
  dc.renderAll();

  //console.log(futureTagsChart.filter())


function postProc(){
  // every time when whole this dashboard is redrawn - we must update list of filters
  // TODO only once
  // TODO maybe there is some more jcy way
  console.log("PP");

    //triggerSimpleGrav()


  var vvv = all.value()
  console.log("Filtered: " + vvv);
  //d3.select('#filteredInfo').html('Filtered: ' + vvv);
  d3.select('.filtered-value').html(""+vvv+"/"+C_ALL);

//   console.log('TOP FEARS', r4.all().top(5));

  
  // TODO 2 rewritten
  var allFilters = []
  for (var cha of CHARTS){
    allFilters = allFilters.concat(cha.filters())
  }
  console.log("Filters: ", allFilters);

// TODO 1 choose Automated equipment   (currently use)



// add button to filters
    /*
    <div class="chart-filter">
        <div class="chart-filter__name truncate">High speed internet connection</div>
        <div class="chart-filter__remove">
            <div class="fa-icon"></div>
        </div>
    </div>
    */

    // d3.select('.chart-filters__inner').selectAll('div.chart-filter')
    var cf0 = d3.selectAll('.chart-filters__inner > div:not(.chart-filter--default)')
    console.log('selectors', cf0)
    cf0.remove()

    var cfdivs = d3.select('.chart-filters__inner').selectAll('div.chart-filter:not(.chart-filter--default)')
        // .data(['18', '78', '900', '17', '1'])       // allFilters
        .data(allFilters)
        .enter()
        .append('div')

    // each container
    cfdivs.classed('chart-filter', true)
    cfdivs.append('div')
        .classed('chart-filter__name truncate', true)
        .text(function(fi){
            // TODO prettify
            dbg_by_name('pr_Y', fi)
            if (Array.isArray(fi)) return "" + extractBraces(fi[0]) + ":" + fi[1];
            if (fi.includes('[')) return extractBraces(fi);
            return fi;
        })
    cfdivs.append('div')
        .classed('chart-filter__remove', true)
        .append('div')
            .classed('fa-icon', true)
            .text('')
            .on("click", function(fi) {rmFilter(fi)})

    // if no one filter applied
    d3.select('.chart-filter--default')
        .style("visibility", function (d) {
            return allFilters.length ? "collapse" : "visible";
        })

    function rmFilter(fullname){
        console.log('MUST RM ' + fullname)

        for (var f of CHARTS){
            if (f.hasFilter(fullname)){
            f.filter(fullname);
            console.log('TOGGLED ' + fullname);
            }
        }
        dc.redrawAll();
    }

}





});








      </script>
   </body>
</html>
